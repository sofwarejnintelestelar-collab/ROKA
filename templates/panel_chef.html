<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cocina - Chef</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            background: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-left: 5px solid #ff6b6b;
        }
        
        .pedido-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            border-left: 5px solid #ff6b6b;
        }
        
        .pedido-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .pedido-header {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .item-card.pendiente {
            border-left: 4px solid #ffc107;
            background: #fff9e6;
        }
        
        .item-card.proceso {
            border-left: 4px solid #0dcaf0;
            background: #e6f7ff;
        }
        
        .item-card.listo {
            border-left: 4px solid #198754;
            background: #e6ffe6;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .badge-estado {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-pendiente {
            background: #ffc107;
            color: #000;
        }
        
        .badge-proceso {
            background: #0dcaf0;
            color: #000;
        }
        
        .badge-listo {
            background: #198754;
            color: white;
        }
        
        .btn-accion {
            margin: 2px;
            font-size: 12px;
        }
        
        .notificacion-chef {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.5s ease-out;
            background: #ff6b6b;
            color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .timer {
            font-family: 'Courier New', monospace;
            background: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .comida-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .filtro-btn {
            margin: 2px;
            border-radius: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">üë®‚Äçüç≥ Cocina - Panel del Chef</h2>
                    <p class="mb-0 text-muted">Actualizaci√≥n autom√°tica de pedidos</p>
                </div>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <span class="badge bg-primary" id="estadoConexion">
                            <span class="spinner-border spinner-border-sm" role="status"></span> Conectando...
                        </span>
                    </div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="cargarPedidos()">
                        Actualizar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="probarSonido()">
                        Probar Sonido
                    </button>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="mt-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary filtro-btn active" onclick="filtrarPedidos('todos')">
                        Todos
                    </button>
                    <button type="button" class="btn btn-outline-warning filtro-btn" onclick="filtrarPedidos('pendiente')">
                        Pendientes
                    </button>
                    <button type="button" class="btn btn-outline-info filtro-btn" onclick="filtrarPedidos('proceso')">
                        En Proceso
                    </button>
                    <button type="button" class="btn btn-outline-success filtro-btn" onclick="filtrarPedidos('listo')">
                        Listos
                    </button>
                </div>
                <div class="form-check form-switch mt-2 d-inline-block ms-3">
                    <input class="form-check-input" type="checkbox" id="sonidoToggle" checked>
                    <label class="form-check-label" for="sonidoToggle">Sonido activado</label>
                </div>
            </div>
        </div>

        <!-- Contador de pedidos -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">Pendientes</h5>
                        <h2 id="contadorPendientes" class="mb-0">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title">En Proceso</h5>
                        <h2 id="contadorProceso" class="mb-0">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">Listos</h5>
                        <h2 id="contadorListos" class="mb-0">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-secondary">
                    <div class="card-body">
                        <h5 class="card-title">Total</h5>
                        <h2 id="contadorTotal" class="mb-0">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pedidos -->
        <div id="pedidosContainer">
            <!-- Los pedidos se cargar√°n autom√°ticamente aqu√≠ -->
            <div class="empty-state">
                <i>üìã</i>
                <h4>No hay pedidos en cocina</h4>
                <p>Esperando nuevos pedidos...</p>
            </div>
        </div>
    </div>

    <!-- Audio para notificaciones (oculto) -->
    <audio id="notificacionAudio" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="alertaAudio" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let socket = null;
        let pedidos = [];
        let pedidosFiltrados = [];
        let filtroActual = 'todos';
        let sonidoActivo = true;
        let notificacionesActivas = [];

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üë®‚Äçüç≥ Panel del Chef inicializando...');
            conectarWebSocket();
            cargarPedidos();
            
            // Configurar toggle de sonido
            document.getElementById('sonidoToggle').addEventListener('change', function() {
                sonidoActivo = this.checked;
                console.log('Sonido:', sonidoActivo ? 'Activado' : 'Desactivado');
            });
            
            // Cargar pedidos cada 30 segundos por si acaso
            setInterval(cargarPedidos, 30000);
        });

        // Conectar WebSocket con namespace espec√≠fico para chef
        function conectarWebSocket() {
            socket = io('/chef', {
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', () => {
                console.log('‚úÖ Conectado al WebSocket del chef');
                document.getElementById('estadoConexion').innerHTML = '‚úÖ Conectado';
                document.getElementById('estadoConexion').className = 'badge bg-success';
                
                // Unirse al canal del chef
                socket.emit('join_chef', {
                    usuario_id: {{ usuario.id if usuario else 0 }},
                    nombre: '{{ usuario.nombre if usuario else "Chef" }}'
                });
            });
            
            socket.on('disconnect', () => {
                console.log('‚ùå Desconectado del WebSocket');
                document.getElementById('estadoConexion').innerHTML = '‚ùå Desconectado';
                document.getElementById('estadoConexion').className = 'badge bg-danger';
            });
            
            socket.on('connection_response', (data) => {
                console.log('Respuesta del servidor:', data);
            });
            
            // ESCUCHAR NUEVOS PEDIDOS EN TIEMPO REAL
            socket.on('nuevo_pedido_chef', (data) => {
                console.log('üéâ ¬°NUEVO PEDIDO RECIBIDO!', data);
                
                // Reproducir sonido de notificaci√≥n
                if (sonidoActivo) {
                    reproducirSonidoNotificacion();
                }
                
                // Mostrar notificaci√≥n visual
                mostrarNotificacionChef(`üìã Nuevo pedido #${data.pedido_id} - Mesa ${data.mesa_numero}`, 'nuevo');
                
                // Actualizar la lista de pedidos
                cargarPedidos();
            });
            
            // ESCUCHAR CAMBIOS DE ESTADO EN TIEMPO REAL
            socket.on('cambiar_estado_item_chef', (data) => {
                console.log('üîÑ Cambio de estado recibido:', data);
                
                // Reproducir sonido de alerta si es listo
                if (sonidoActivo && data.nuevo_estado === 'listo') {
                    reproducirSonidoAlerta();
                    mostrarNotificacionChef(`‚úÖ ${data.producto_nombre} listo - Mesa ${data.mesa_numero}`, 'listo');
                }
                
                // Actualizar la lista de pedidos
                cargarPedidos();
            });
            
            socket.on('connect_error', (error) => {
                console.error('Error de conexi√≥n:', error);
                document.getElementById('estadoConexion').innerHTML = '‚ö†Ô∏è Error de conexi√≥n';
                document.getElementById('estadoConexion').className = 'badge bg-warning';
            });
        }

        // Cargar pedidos desde la API
        async function cargarPedidos() {
            try {
                const response = await fetch('/api/pedidos_cocina_comidas');
                if (!response.ok) throw new Error('Error al cargar pedidos');
                
                pedidos = await response.json();
                console.log(`üìä ${pedidos.length} pedidos cargados`);
                aplicarFiltro();
                renderizarPedidos();
                actualizarContadores();
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                mostrarNotificacionChef('‚ùå Error cargando pedidos', 'error');
            }
        }

        // Aplicar filtro actual
        function aplicarFiltro() {
            if (filtroActual === 'todos') {
                pedidosFiltrados = pedidos;
            } else {
                pedidosFiltrados = pedidos.filter(pedido => {
                    const itemsFiltrados = pedido.items.filter(item => item.estado_item === filtroActual);
                    return itemsFiltrados.length > 0;
                });
            }
        }

        // Cambiar filtro
        function filtrarPedidos(filtro) {
            filtroActual = filtro;
            
            // Actualizar botones activos
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            aplicarFiltro();
            renderizarPedidos();
        }

        // Renderizar pedidos en la interfaz
        function renderizarPedidos() {
            const container = document.getElementById('pedidosContainer');
            
            if (pedidosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>üìã</i>
                        <h4>No hay pedidos ${filtroActual === 'todos' ? '' : filtroActual}</h4>
                        <p>${filtroActual === 'pendiente' ? '¬°Todo al d√≠a!' : 'Esperando nuevos pedidos...'}</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            pedidosFiltrados.forEach(pedido => {
                // Contar items por estado para este pedido
                const itemsPendientes = pedido.items.filter(item => item.estado_item === 'pendiente').length;
                const itemsProceso = pedido.items.filter(item => item.estado_item === 'proceso').length;
                const itemsListos = pedido.items.filter(item => item.estado_item === 'listo').length;
                
                // Calcular tiempo transcurrido
                const tiempoTranscurrido = calcularTiempoTranscurrido(pedido.fecha_apertura);
                
                html += `
                    <div class="pedido-card">
                        <div class="pedido-header">
                            <div>
                                <h5 class="mb-1">Pedido #${pedido.id}</h5>
                                <small class="opacity-75">
                                    Mesa ${pedido.mesa_numero} ‚Ä¢ Mozo: ${pedido.mozo_nombre}
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="timer mb-1">${tiempoTranscurrido}</div>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-warning">${itemsPendientes} pendientes</span>
                                    <span class="badge bg-info">${itemsProceso} en proceso</span>
                                    <span class="badge bg-success">${itemsListos} listos</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3">
                            ${renderizarItemsPedido(pedido)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Renderizar items de un pedido
        function renderizarItemsPedido(pedido) {
            let html = '';
            
            pedido.items.forEach(item => {
                // Calcular tiempo transcurrido para este item
                let tiempoItem = '';
                if (item.tiempo_inicio) {
                    const inicio = new Date(item.tiempo_inicio);
                    const ahora = new Date();
                    const minutos = Math.floor((ahora - inicio) / 60000);
                    tiempoItem = `<small class="text-muted ms-2">(${minutos} min)</small>`;
                }
                
                html += `
                    <div class="item-card ${item.estado_item}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <h6 class="mb-1">${item.producto_nombre} √ó ${item.cantidad}</h6>
                                ${item.observaciones ? `<small class="text-muted d-block">üìù ${item.observaciones}</small>` : ''}
                                <div class="mt-2">
                                    <span class="badge-estado badge-${item.estado_item}">
                                        ${item.estado_item === 'pendiente' ? 'Pendiente' : 
                                          item.estado_item === 'proceso' ? 'En Proceso' : 'Listo'}
                                    </span>
                                    ${tiempoItem}
                                </div>
                            </div>
                            <div class="btn-group-vertical">
                                ${item.estado_item === 'pendiente' ? `
                                <button class="btn btn-sm btn-warning btn-accion" onclick="cambiarEstadoItem(${item.id}, 'proceso')">
                                    Iniciar
                                </button>
                                ` : ''}
                                
                                ${item.estado_item === 'proceso' ? `
                                <button class="btn btn-sm btn-success btn-accion" onclick="cambiarEstadoItem(${item.id}, 'listo')">
                                    Terminar
                                </button>
                                <button class="btn btn-sm btn-secondary btn-accion" onclick="cambiarEstadoItem(${item.id}, 'pendiente')">
                                    Revertir
                                </button>
                                ` : ''}
                                
                                ${item.estado_item === 'listo' ? `
                                <button class="btn btn-sm btn-secondary btn-accion" onclick="cambiarEstadoItem(${item.id}, 'proceso')">
                                    Volver a Proceso
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        // Actualizar contadores
        function actualizarContadores() {
            let totalPendientes = 0;
            let totalProceso = 0;
            let totalListos = 0;
            
            pedidos.forEach(pedido => {
                pedido.items.forEach(item => {
                    if (item.estado_item === 'pendiente') totalPendientes++;
                    if (item.estado_item === 'proceso') totalProceso++;
                    if (item.estado_item === 'listo') totalListos++;
                });
            });
            
            document.getElementById('contadorPendientes').textContent = totalPendientes;
            document.getElementById('contadorProceso').textContent = totalProceso;
            document.getElementById('contadorListos').textContent = totalListos;
            document.getElementById('contadorTotal').textContent = pedidos.length;
        }

        // Cambiar estado de un item
        async function cambiarEstadoItem(itemId, nuevoEstado) {
            try {
                const response = await fetch('/api/actualizar_item_estado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        estado: nuevoEstado
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reproducir sonido seg√∫n el estado
                    if (sonidoActivo) {
                        if (nuevoEstado === 'listo') {
                            reproducirSonidoAlerta();
                        } else if (nuevoEstado === 'proceso') {
                            reproducirSonidoNotificacion();
                        }
                    }
                    
                    // Actualizar la lista
                    cargarPedidos();
                } else {
                    alert(`‚ùå Error: ${data.message}`);
                }
            } catch (error) {
                console.error('Error cambiando estado:', error);
                alert('‚ùå Error al cambiar estado');
            }
        }

        // Calcular tiempo transcurrido
        function calcularTiempoTranscurrido(fechaStr) {
            if (!fechaStr) return '--:--';
            
            const fecha = new Date(fechaStr);
            const ahora = new Date();
            const diferencia = Math.floor((ahora - fecha) / 60000); // minutos
            
            if (diferencia < 60) {
                return `${diferencia} min`;
            } else {
                const horas = Math.floor(diferencia / 60);
                const minutos = diferencia % 60;
                return `${horas}h ${minutos}m`;
            }
        }

        // Mostrar notificaci√≥n para el chef
        function mostrarNotificacionChef(mensaje, tipo = 'info') {
            // Evitar notificaciones duplicadas
            const notificacionId = Date.now();
            
            const notificacion = document.createElement('div');
            notificacion.id = `notif-${notificacionId}`;
            notificacion.className = 'notificacion-chef';
            notificacion.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex: 1;">
                        <strong>${tipo === 'nuevo' ? 'üéâ NUEVO PEDIDO' : tipo === 'listo' ? '‚úÖ LISTO' : '‚ÑπÔ∏è'}</strong>
                        <div class="mt-1">${mensaje}</div>
                    </div>
                    <button class="btn btn-sm btn-light ms-2" onclick="cerrarNotificacion('${notificacionId}')">
                        √ó
                    </button>
                </div>
            `;
            
            document.body.appendChild(notificacion);
            
            // Auto-eliminar despu√©s de 5 segundos
            setTimeout(() => {
                cerrarNotificacion(notificacionId);
            }, 5000);
            
            // Guardar referencia
            notificacionesActivas.push(notificacionId);
        }

        // Cerrar notificaci√≥n
        function cerrarNotificacion(id) {
            const notificacion = document.getElementById(`notif-${id}`);
            if (notificacion) {
                notificacion.remove();
                
                // Eliminar de la lista activa
                const index = notificacionesActivas.indexOf(id);
                if (index > -1) {
                    notificacionesActivas.splice(index, 1);
                }
            }
        }

        // Reproducir sonido de notificaci√≥n
        function reproducirSonidoNotificacion() {
            try {
                const audio = document.getElementById('notificacionAudio');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Error reproduciendo sonido:', e));
                }
            } catch (error) {
                console.log('Sonido no disponible');
            }
        }

        // Reproducir sonido de alerta
        function reproducirSonidoAlerta() {
            try {
                const audio = document.getElementById('alertaAudio');
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Error reproduciendo alerta:', e));
                }
            } catch (error) {
                console.log('Alerta no disponible');
            }
        }

        // Probar sonido
        function probarSonido() {
            reproducirSonidoNotificacion();
            mostrarNotificacionChef('üîä Sonido de prueba reproducido', 'info');
        }

        // Hacer funciones globales
        window.cargarPedidos = cargarPedidos;
        window.filtrarPedidos = filtrarPedidos;
        window.cambiarEstadoItem = cambiarEstadoItem;
        window.probarSonido = probarSonido;
        window.cerrarNotificacion = cerrarNotificacion;
    </script>
</body>
</html>