<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .badge-comida { background-color: #6f42c1; }
        .badge-bebida { background-color: #20c997; }
        .badge-producto { background-color: #fd7e14; }
        .badge-sin-stock { background-color: #28a745; }
        .badge-con-stock { background-color: #17a2b8; }
        .btn-volver-caja {
            background-color: #198754;
            border-color: #198754;
            color: white;
        }
        .btn-volver-caja:hover {
            background-color: #157347;
            border-color: #146c43;
            color: white;
        }
    </style>
</head>

<body>
<div class="container mt-4">

    <!-- Header con botón para volver a caja -->
    <header class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i data-feather="package" class="me-2"></i> Productos</h2>
            <p class="text-muted mb-0">Gestión de productos y precios</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <!-- Botón para volver a caja -->
            <a href="{{ url_for('caja') }}" class="btn btn-volver-caja btn-sm">
                <i data-feather="shopping-cart" class="me-1"></i> Volver a Caja
            </a>
            
            <div class="btn-group btn-group-sm ms-2">
                <button class="btn btn-outline-secondary" onclick="filtrarPorTipo('todos')">
                    Todos
                </button>
                <button class="btn btn-outline-primary" onclick="filtrarPorTipo('comida')">
                    <i data-feather="coffee"></i> Comidas
                </button>
                <button class="btn btn-outline-success" onclick="filtrarPorTipo('bebida')">
                    <i data-feather="droplet"></i> Bebidas
                </button>
                <button class="btn btn-outline-warning" onclick="filtrarPorTipo('producto')">
                    <i data-feather="box"></i> Productos
                </button>
            </div>
        </div>
    </header>

    <!-- Tarjeta principal -->
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <div>
                <h5 class="mb-0"><i data-feather="list" class="me-2"></i> Lista de productos</h5>
                <small class="text-muted">
                    <span class="badge badge-comida me-1">Comidas</span> 
                    <span class="badge badge-bebida me-1">Bebidas</span> 
                    <span class="badge badge-producto">Productos</span>
                </small>
            </div>
            <div>
                <a href="{{ url_for('crear_producto') }}" class="btn btn-primary btn-sm">
                    <i data-feather="plus" class="me-1"></i> Nuevo producto
                </a>
            </div>
        </div>

        <div class="card-body">
            <!-- Búsqueda -->
            <div class="mb-4">
                <form method="GET" class="row g-2 align-items-center">
                    <div class="col-md-8">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">
                                <i data-feather="search"></i>
                            </span>
                            <input type="text" class="form-control" 
                                   name="search" placeholder="Buscar por nombre..."
                                   value="{{ search if search else '' }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i data-feather="search" class="me-1"></i> Buscar
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a href="/productos" class="btn btn-outline-secondary btn-sm w-100">
                            <i data-feather="refresh-cw" class="me-1"></i> Limpiar
                        </a>
                    </div>
                </form>
            </div>

            <!-- Tabla de productos -->
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th width="100">Tipo</th>
                            <th width="100">Código</th>
                            <th>Nombre</th>
                            <th width="120">Precio</th>
                            <th width="120">Stock</th>
                            <th width="150">Categoría</th>
                            <th width="200">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in productos %}
                        <tr class="producto-fila" data-tipo="{{ p.tipo }}">
                            <td>
                                {% if p.tipo == 'comida' %}
                                    <span class="badge badge-comida">Comida</span>
                                {% elif p.tipo == 'bebida' %}
                                    <span class="badge badge-bebida">Bebida</span>
                                {% else %}
                                    <span class="badge badge-producto">Producto</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if p.es_comida %}
                                    <small class="text-muted">(Plato)</small>
                                {% else %}
                                    <code class="text-primary">{{ p.codigo_barra or '-' }}</code>
                                {% endif %}
                            </td>
                            <td class="fw-medium">
                                {{ p.nombre or '' }}
                                {% if p.es_comida %}
                                    <br><small class="text-muted">Plato del menú</small>
                                {% endif %}
                            </td>
                            <td class="text-nowrap">
                                ${{ "%.2f"|format(p.precio) if p.precio else '0.00' }}
                            </td>
                            <td>
                                {% if p.es_comida %}
                                    <span class="badge bg-success">Disponible</span>
                                {% elif p.tipo == 'bebida' %}
                                    {% if p.stock > 10 %}
                                        <span class="badge bg-success">{{ p.stock }}</span>
                                    {% elif p.stock > 0 %}
                                        <span class="badge bg-warning text-dark">{{ p.stock }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">Agotado</span>
                                    {% endif %}
                                {% else %}
                                    {% if p.stock > 20 %}
                                        <span class="badge bg-success">{{ p.stock }}</span>
                                    {% elif p.stock > 5 %}
                                        <span class="badge bg-warning text-dark">{{ p.stock }}</span>
                                    {% elif p.stock == 0 %}
                                        <span class="badge bg-danger">Agotado</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ p.stock }}</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if p.categoria_nombre %}
                                    <span class="badge bg-info text-dark">{{ p.categoria_nombre }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">Sin categoría</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('editar_producto', id=p.id) }}" 
                                       class="btn btn-outline-secondary" title="Editar">
                                        <i data-feather="edit-2"></i>
                                    </a>
                                    <a href="{{ url_for('eliminar_producto', id=p.id) }}" 
                                       class="btn btn-outline-danger"
                                       onclick="return confirm('¿Eliminar \"{{ p.nombre }}\"?');"
                                       title="Eliminar">
                                        <i data-feather="trash-2"></i>
                                    </a>
                                    {% if not p.es_comida %}
                                        <button class="btn btn-outline-primary" 
                                                onclick="window.location.href='/?agregar={{ p.codigo_barra|urlencode if p.codigo_barra else p.id }}'"
                                                title="Agregar a venta">
                                            <i data-feather="shopping-cart"></i>
                                        </button>
                                    {% else %}
                                        <button class="btn btn-outline-success" 
                                                onclick="window.location.href='/?agregar={{ p.codigo_barra|urlencode if p.codigo_barra else p.id }}'"
                                                title="Agregar a venta">
                                            <i data-feather="shopping-cart"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <i data-feather="package" style="width: 48px; height: 48px;"></i>
                                <p class="mt-3">
                                    {% if search %}
                                        No se encontraron productos con "{{ search }}"
                                    {% else %}
                                        No hay productos registrados
                                    {% endif %}
                                </p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Resumen -->
            <div class="mt-3 text-center">
                <small class="text-muted">
                    Total: {{ productos|length }} productos 
                    ({% set comidas = productos|selectattr('es_comida')|list|length %}
                     {% set bebidas = productos|selectattr('tipo', 'equalto', 'bebida')|list|length %}
                     {% set productos_count = productos|selectattr('tipo', 'equalto', 'producto')|list|length %}
                     {{ comidas }} comidas, {{ bebidas }} bebidas, {{ productos_count }} productos)
                </small>
            </div>

        </div>
    </div>

    <!-- Botón adicional para volver a caja en el footer -->
    <div class="mt-3 text-center">
        <a href="{{ url_for('caja') }}" class="btn btn-volver-caja btn-sm">
            <i data-feather="shopping-cart" class="me-1"></i> Volver al Panel de Caja
        </a>
        <a href="{{ url_for('crear_producto') }}" class="btn btn-outline-primary btn-sm ms-2">
            <i data-feather="plus" class="me-1"></i> Crear Nuevo Producto
        </a>
    </div>

</div>

<script>
feather.replace();

function filtrarPorTipo(tipo) {
    const filas = document.querySelectorAll('.producto-fila');
    filas.forEach(fila => {
        if (tipo === 'todos') {
            fila.style.display = '';
        } else if (fila.getAttribute('data-tipo') === tipo) {
            fila.style.display = '';
        } else {
            fila.style.display = 'none';
        }
    });
}

// Mostrar tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Tecla rápida para volver a caja: Ctrl + C
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        window.location.href = "{{ url_for('caja') }}";
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>