<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Pedido #{{ pedido.id }} - Mesa {{ pedido.mesa_numero }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .estado-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .estado-pendiente { background: #fff3cd; color: #856404; }
        .estado-preparacion { background: #cce5ff; color: #004085; }
        .estado-listo { background: #d4edda; color: #155724; }
        .estado-entregado { background: #d1ecf1; color: #0c5460; }
        .estado-pagado { background: #d1f7c4; color: #0c6b0c; }
        .estado-cancelado { background: #f8d7da; color: #721c24; }
        .pedido-header {
            background: linear-gradient(135deg, #2b8a3e 0%, #51cf66 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
        }
        .item-pedido {
            border-left: 4px solid #2b8a3e;
            background: #f8fff9;
        }
        .btn-estado {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">
                    <i data-feather="clipboard" class="text-primary"></i> Pedido #{{ pedido.id }}
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('pedidos') }}">Pedidos</a></li>
                        <li class="breadcrumb-item active">Mesa {{ pedido.mesa_numero }}</li>
                    </ol>
                </nav>
            </div>
            <div>
                <a href="{{ url_for('pedidos') }}" class="btn btn-outline-secondary">
                    <i data-feather="arrow-left"></i> Volver
                </a>
            </div>
        </div>

        <!-- Información del pedido -->
        <div class="pedido-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h1 class="display-4">Mesa {{ pedido.mesa_numero }}</h1>
                    <small><i data-feather="users"></i> {{ pedido.mesa_capacidad }} personas</small>
                </div>
                <div class="col-md-3">
                    <p class="mb-1"><i data-feather="user"></i> {{ pedido.usuario_nombre }}</p>
                    <p class="mb-0"><i data-feather="clock"></i> {{ pedido.created_at }}</p>
                </div>
                <div class="col-md-3">
                    <div class="h4 mb-1">Estado:</div>
                    <span class="estado-badge estado-{{ pedido.estado }}">
                        {{ pedido.estado|title }}
                    </span>
                </div>
                <div class="col-md-3 text-end">
                    <div class="h1 mb-0">${{ "%.2f"|format(pedido.total) }}</div>
                    <small>{{ items|length }} productos</small>
                </div>
            </div>
            
            {% if pedido.observaciones %}
            <div class="mt-3 pt-3 border-top">
                <strong><i data-feather="message-square"></i> Observaciones:</strong>
                <p class="mb-0">{{ pedido.observaciones }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Controles de estado -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i data-feather="refresh-cw"></i> Cambiar Estado del Pedido</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('cambiar_estado_pedido', pedido_id=pedido.id, estado='pendiente') }}" 
                       class="btn btn-outline-warning btn-estado {% if pedido.estado == 'pendiente' %}active{% endif %}">
                        Pendiente
                    </a>
                    <a href="{{ url_for('cambiar_estado_pedido', pedido_id=pedido.id, estado='preparacion') }}" 
                       class="btn btn-outline-primary btn-estado {% if pedido.estado == 'preparacion' %}active{% endif %}">
                        En Preparación
                    </a>
                    <a href="{{ url_for('cambiar_estado_pedido', pedido_id=pedido.id, estado='listo') }}" 
                       class="btn btn-outline-success btn-estado {% if pedido.estado == 'listo' %}active{% endif %}">
                        Listo
                    </a>
                    <a href="{{ url_for('cambiar_estado_pedido', pedido_id=pedido.id, estado='entregado') }}" 
                       class="btn btn-outline-info btn-estado {% if pedido.estado == 'entregado' %}active{% endif %}">
                        Entregado
                    </a>
                </div>
                
                {% if pedido.estado in ['listo', 'entregado'] and usuario.rol in ['admin', 'cajero'] %}
                <div class="mt-3">
                    <a href="{{ url_for('procesar_pago_pedido', pedido_id=pedido.id) }}" 
                       class="btn btn-success">
                        <i data-feather="dollar-sign"></i> Procesar Pago
                    </a>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <a href="{{ url_for('cambiar_estado_pedido', pedido_id=pedido.id, estado='cancelado') }}" 
                       class="btn btn-outline-danger"
                       onclick="return confirm('¿Cancelar este pedido?')">
                        <i data-feather="x-circle"></i> Cancelar Pedido
                    </a>
                </div>
            </div>
        </div>

        <!-- Items del pedido -->
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i data-feather="package"></i> Productos del Pedido</h5>
                <span class="badge bg-primary">{{ items|length }} items</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Precio Unitario</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr class="item-pedido">
                                <td>
                                    <strong>{{ item.producto_nombre }}</strong>
                                    {% if item.producto_id %}
                                    <br>
                                    <small class="text-muted">ID: {{ item.producto_id }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary rounded-pill" style="font-size: 1rem;">
                                        {{ item.cantidad }}
                                    </span>
                                </td>
                                <td class="text-end">${{ "%.2f"|format(item.precio_unitario) }}</td>
                                <td class="text-end">
                                    <strong>${{ "%.2f"|format(item.subtotal) }}</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                <td class="text-end">
                                    <h4 class="text-success mb-0">${{ "%.2f"|format(pedido.total) }}</h4>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="mt-4 text-center">
            <a href="{{ url_for('pedidos') }}" class="btn btn-outline-secondary me-2">
                <i data-feather="arrow-left"></i> Volver a Pedidos
            </a>
            {% if pedido.estado not in ['cancelado', 'pagado'] %}
            <a href="{{ url_for('crear_pedido', mesa_id=pedido.mesa_id) }}" class="btn btn-primary me-2">
                <i data-feather="plus-circle"></i> Nuevo Pedido en esta Mesa
            </a>
            {% endif %}
            {% if pedido.estado in ['listo', 'entregado'] and usuario.rol in ['admin', 'cajero'] %}
            <a href="{{ url_for('procesar_pago_pedido', pedido_id=pedido.id) }}" class="btn btn-success">
                <i data-feather="credit-card"></i> Cobrar Pedido
            </a>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        feather.replace();
        
        // Auto-recargar cada 30 segundos si el pedido está activo
        const estadosActivos = ['pendiente', 'preparacion', 'listo'];
        if (estadosActivos.includes("{{ pedido.estado }}")) {
            setInterval(() => {
                window.location.reload();
            }, 30000);
        }
    </script>
</body>
</html>